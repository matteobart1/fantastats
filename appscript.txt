function doGet(e) {
  const action = e.parameter.action || 'podio';
  
  if (action === 'images') {
    return doGetImages();
  } else {
    return doGetPodio();
  }
}

function doGetPodio() {
  const sheet = SpreadsheetApp.getActive().getSheetByName('dati_podio');
  if (!sheet) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: 'Foglio "dati_podio" non trovato.' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const data = sheet.getDataRange().getValues();
  if (!data.length) {
    return ContentService.createTextOutput('[]').setMimeType(ContentService.MimeType.JSON);
  }

  const headers = data.shift();
  const rows = data
    .filter(row => row[0] !== '')
    .map(row =>
      headers.reduce((acc, header, i) => {
        acc[header] = row[i];
        return acc;
      }, {})
    );

  return ContentService
    .createTextOutput(JSON.stringify(rows))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGetImages() {
  const sheet = SpreadsheetApp.getActive().getSheetByName('img');
  if (!sheet) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: 'Foglio "img" non trovato.' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const data = sheet.getDataRange().getValues();
  if (!data.length) {
    return ContentService.createTextOutput('{}').setMimeType(ContentService.MimeType.JSON);
  }

  const headers = data[0];
  const rows = data.slice(1).filter(row => row[0] !== '');
  
  const coachImages = {};
  rows.forEach(row => {
    const coachName = row[0];
    const imgUrl = row[1];
    if (coachName && imgUrl) {
      coachImages[coachName] = imgUrl;
    }
  });

  return ContentService
    .createTextOutput(JSON.stringify(coachImages))
    .setMimeType(ContentService.MimeType.JSON);
}
